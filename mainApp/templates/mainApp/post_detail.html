{% extends "mainApp/wrapper.html" %}

{%  load crispy_forms_tags %} <!--for better forms-->

{% block content %}
	<style type="text/css">
		.head {margin-bottom: 10px;}
		.user{margin-right: 10px;}
		hr {border-top: 1px solid #000 !important;}
	</style>

	<div id="img_class" style="height:200px; width:300px;">
	<img src="/media/{{ post_detail.image }}" style="margin:0px auto;display:block;max-width:100%; 
  													max-height:100%;" >
  	</div>
  	<br><br>
	<h4 align="center">{{ post_detail.title }}</h4><br>
	<p>{{ post_detail.text }}</p>

	<h4>Comments:</h4>
	<hr>

	<div class="container new_comment">	
	</div>
	{%  for com in post_comments%}
		<div class="container">
			<div class="row comment">
			    <div class="head">
			        <small>
			        	<strong class="user">{{ com.author.username }}</strong>
			        	{{ com.timestamp }}
			        </small>
			        <br>
			    </div>    
			    <p>{{ com.comment|safe }}</p>
			</div>
		</div>
	{%  endfor %}

	<div class="col-sm-7 col-sm-offset-2">
		<form action="" method="POST">
			<input type="hidden" id="post" data-id="{{ post_detail.id }}">
			{% csrf_token %}
			{{ form|crispy }}
			<input type="submit" value="Add comment" id="add_comment">
		</form>
	</div>

	<script type="text/javascript">
		$(document).ready(function() {
			function getCookie(name) {   //for generating csrf token
    			var cookieValue = null;
    			if (document.cookie && document.cookie !== '') {
        			var cookies = document.cookie.split(';');
        			for (var i = 0; i < cookies.length; i++) {
            			var cookie = jQuery.trim(cookies[i]);
            			// Does this cookie string begin with the name we want?
            			if (cookie.substring(0, name.length + 1) === (name + '=')) {
                			cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                			break;
            			}
        			}
    			}
    			return cookieValue;
			}
			var csrftoken = getCookie('csrftoken');
			$('#add_comment').on('click', function(e){
				e.preventDefault()
				var post_detail_id = $('#post').attr('data-id')
				var comment = $('#id_comment').val()
				
				data = {
					post_detail_id: post_detail_id,
					comment: comment,
					csrfmiddlewaretoken:csrftoken
				}

				$.ajax({
					type:"POST",
					url:"{% url 'add_comment' %}",
					dataType:"json",
					data:data,
					success: function(data){
						$.each(data, function(field) {
							$('.new_comment').prepend('<div class="row comment"><div class="head"><small><strongclass="user">' + data[field]['author'] + '</strong>'+ data[field]['timestamp'] + 
								'</small><br></div><p>' + data[field]['comment'] + 
								'</p></div></div>')
								$('#id_comment').val('') 
						})
					}
				})
			})
		})
	</script>
{% endblock %}